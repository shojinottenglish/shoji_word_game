<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHOJI先生の英単語道場</title>
    <!-- Tailwind CSS CDNを読み込み -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tone.js CDNを読み込み (サウンドエフェクト、BGM用) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        /* カスタムフォントの指定 */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* 背景色を少し柔らかく */
            /* 教室の背景画像パスをGitHub対応に修正 */
            background-image: url('./images/classroom.png'); /* GitHubリポジトリのimagesフォルダ内のclassroom.png */
            background-size: cover; /* 画面全体に広がるように */
            background-position: center; /* 中央に配置 */
            background-attachment: fixed; /* スクロールしても固定 */
        }
        /* ボタンのホバーエフェクト */
        .answer-button:hover, .action-button:hover, .difficulty-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
        }
        .answer-button:active, .action-button:active, .difficulty-button:active {
            transform: translateY(0);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        /* メッセージボックスの基本スタイル */
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            text-align: center;
            display: none; /* 初期状態では非表示 */
            max-width: 90%; /* モバイル対応 */
            width: 500px;
        }
        .message-box-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none; /* 初期状態では非表示 */
        }
        /* 黒板の単語表示アニメーション */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .blackboard-word-animated {
            animation: fadeIn 0.5s ease-out forwards;
        }
        /* タイマーバーのスタイル */
        #timer-bar-container {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 9999px; /* rounded-full */
            height: 1.5rem; /* h-6 */
            overflow: hidden;
            margin-top: 1rem; /* mt-4 */
        }
        #timer-bar {
            height: 100%;
            width: 100%; /* 初期値 */
            background-color: #22c55e; /* green-500 */
            border-radius: 9999px; /* rounded-full */
            transition: width linear; /* スムーズなアニメーション */
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
    <!-- メインゲームコンテナ -->
    <div id="game-container" class="bg-white bg-opacity-90 rounded-2xl shadow-xl p-8 w-full max-w-2xl flex flex-col items-center space-y-8">
        <!-- ヘッダー部分：タイトルとスコア -->
        <div class="w-full flex justify-between items-center pb-4 border-b-2 border-gray-200">
            <h1 class="text-4xl font-extrabold text-indigo-700">SHOJI先生の英単語道場</h1>
            <div class="text-2xl font-bold text-gray-700">
                スコア: <span id="score">0</span> / <span id="total-questions">100</span>
            </div>
        </div>

        <!-- SHOJI先生のエリア -->
        <div class="w-full bg-blue-100 rounded-xl p-6 shadow-md flex items-center space-x-4">
            <!-- SHOJI先生の顔画像をGitHub対応に修正 -->
            <img src="./images/shojisensei.jpg" alt="SHOJI先生の顔" class="rounded-full border-4 border-blue-300 object-cover w-20 h-20">
            <p id="shoji-comment" class="text-xl text-blue-800 font-semibold">
                準備はいいかい？さあ、今日の英単語だ！
            </p>
        </div>

        <!-- プレイヤー情報とステータス表示 -->
        <div class="w-full bg-purple-100 rounded-xl p-4 shadow-md text-center">
            <h2 class="text-2xl font-bold text-purple-700 mb-2">プレイヤー情報</h2>
            <div class="grid grid-cols-3 gap-2 text-lg text-purple-800 font-semibold">
                <span>学力: <span id="stat-academic">1</span></span>
                <span>集中力: <span id="stat-concentration">1</span></span>
                <span>運: <span id="stat-luck">1</span></span>
            </div>
            <p id="current-day-display" class="text-xl font-bold text-purple-800 mt-2">1日目</p>
        </div>

        <!-- 黒板エリア -->
        <div id="blackboard-area" class="w-full bg-gray-800 text-white rounded-xl p-10 shadow-lg flex items-center justify-center min-h-[150px]">
            <p id="blackboard-word" class="text-5xl font-extrabold text-yellow-300 text-center">
                ゲームスタート！
            </p>
        </div>

        <!-- タイマー表示エリア -->
        <div id="timer-area" class="w-full hidden"> <!-- hiddenクラスで初期非表示 -->
            <div id="timer-bar-container">
                <div id="timer-bar"></div>
            </div>
            <p id="timer-text" class="text-lg font-bold text-gray-600 text-center">残り時間: --秒</p>
        </div>

        <!-- 選択肢ボタンエリア -->
        <div id="answer-buttons" class="grid grid-cols-1 md:grid-cols-2 gap-4 w-full">
            <!-- ボタンはJavaScriptで動的に生成されます -->
        </div>

        <!-- 難易度選択エリア -->
        <div id="difficulty-selection" class="w-full flex flex-col items-center space-y-4">
            <h2 class="text-3xl font-bold text-indigo-700">難易度を選択</h2>
            <button data-difficulty="easy" class="difficulty-button px-8 py-4 bg-green-500 text-white text-2xl font-bold rounded-full shadow-lg hover:bg-green-600 transition duration-300 ease-in-out transform hover:scale-105">
                かんたん
            </button>
            <button data-difficulty="normal" class="difficulty-button px-8 py-4 bg-yellow-500 text-white text-2xl font-bold rounded-full shadow-lg hover:bg-yellow-600 transition duration-300 ease-in-out transform hover:scale-105">
                ふつう
            </button>
            <button data-difficulty="hard" class="difficulty-button px-8 py-4 bg-red-500 text-white text-2xl font-bold rounded-full shadow-lg hover:bg-red-600 transition duration-300 ease-in-out transform hover:scale-105">
                むずかしい
            </button>
        </div>

        <!-- ゲームコントロールボタン (通常は隠し、状況に応じて表示) -->
        <button id="start-button" class="mt-8 px-8 py-4 bg-green-600 text-white text-2xl font-bold rounded-full shadow-lg hover:bg-green-700 transition duration-300 ease-in-out transform hover:scale-105 hidden">
            ゲームスタート！
        </button>

        <!-- 放課後アクションボタンエリア -->
        <div id="after-school-actions" class="grid grid-cols-1 md:grid-cols-2 gap-4 w-full hidden">
            <button id="action-study" class="action-button px-6 py-4 bg-indigo-500 text-white text-xl font-semibold rounded-xl shadow-md hover:bg-indigo-600 transition duration-300">
                勉強する (+学力)
            </button>
            <button id="action-talk-classmate" class="action-button px-6 py-4 bg-teal-500 text-white text-xl font-semibold rounded-xl shadow-md hover:bg-teal-600 transition duration-300">
                クラスメイトと話す (+親密度)
            </button>
            <button id="action-next-day" class="action-button px-6 py-4 bg-gray-500 text-white text-xl font-semibold rounded-xl shadow-md hover:bg-gray-600 transition duration-300 col-span-full">
                次の日へ
            </button>
            <p id="actions-left-display" class="text-lg font-bold text-gray-700 col-span-full text-center mt-2">
                残りのアクション回数: <span id="remaining-actions">0</span>
            </p>
        </div>

        <!-- フィードバックメッセージ -->
        <p id="feedback-message" class="text-xl font-semibold text-center mt-4 hidden"></p>
    </div>

    <!-- メッセージボックス (ゲームオーバー、イベントなど) -->
    <div id="message-box-overlay" class="message-box-overlay"></div>
    <div id="message-box" class="message-box">
        <h2 id="message-box-title" class="text-3xl font-bold mb-4 text-indigo-700"></h2>
        <p id="message-box-content" class="text-xl text-gray-700 mb-6"></p>
        <button id="message-box-close" class="px-6 py-3 bg-indigo-600 text-white text-lg font-semibold rounded-full shadow-md hover:bg-indigo-700 transition duration-300">
            閉じる
        </button>
    </div>

    <script>
        // ゲームの状態を管理する変数
        let score = 0; // 現在のスコア
        let currentQuestionIndex = 0; // 現在の問題のインデックス
        let questions = []; // 現在の難易度で出題される問題を格納する配列
        const totalQuestionsPerDay = 10; // 1日あたりの問題数
        const totalGameDays = 7; // ゲームの総日数（学園祭までの日数など）
        let currentDay = 1; // 現在の日数
        let difficultyLevel = ''; // 現在の難易度 ('easy', 'normal', 'hard')
        let questionTimeLimit = 10; // 各問題の制限時間（秒） - 集中力で変動
        let timerInterval; // タイマーのsetInterval ID
        let timeLeft; // 残り時間
        let gamePhase = 'start_menu'; // ゲームフェーズ ('start_menu', 'quiz_phase', 'after_school_phase', 'event_phase', 'game_over')

        // プレイヤーのステータス
        const playerStats = {
            academicAbility: 1, // 学力 (クイズの正答率や獲得スコアに影響)
            concentration: 1,   // 集中力 (問題の制限時間に影響)
            luck: 1             // 運 (ランダムイベントやボーナスに影響)
        };

        // その日の正解数と残りの放課後アクション回数
        let correctAnswersToday = 0;
        let availableAfterSchoolActions = 0;

        // クラスメイトのデータ
        const classmates = [
            { id: 'tanaka', name: '田中', affinity: 0, events: [
                { threshold: 5, message: '田中「今日の英語のクイズ、すごかったね！見直し手伝おうか？」', type: 'dialog', triggered: false },
                { threshold: 10, message: '田中「実は、学園祭の発表で英語劇をやりたいんだけど、手伝ってくれないかな？」', type: 'quest', triggered: false }
            ]},
            { id: 'sato', name: '佐藤', affinity: 0, events: [
                { threshold: 5, message: '佐藤「英語、得意なんだね。今度、一緒に勉強しない？」', type: 'dialog', triggered: false },
                { threshold: 10, message: '佐藤「SHOJI先生の特別補習があるらしいんだけど、一緒に行ってみない？」', type: 'quest', triggered: false }
            ]}
        ];

        // DOM要素の取得
        const scoreDisplay = document.getElementById('score');
        const blackboardWord = document.getElementById('blackboard-word');
        const answerButtonsContainer = document.getElementById('answer-buttons');
        const startButton = document.getElementById('start-button');
        const feedbackMessage = document.getElementById('feedback-message');
        const shojiComment = document.getElementById('shoji-comment');
        const totalQuestionsDisplay = document.getElementById('total-questions');
        const timerBar = document.getElementById('timer-bar');
        const timerText = document.getElementById('timer-text');
        const timerArea = document.getElementById('timer-area'); // タイマーエリア全体

        // プレイヤー情報表示
        const statAcademic = document.getElementById('stat-academic');
        const statConcentration = document.getElementById('stat-concentration');
        const statLuck = document.getElementById('stat-luck');
        const currentDayDisplay = document.getElementById('current-day-display');

        // 難易度選択UI
        const difficultySelection = document.getElementById('difficulty-selection');
        const difficultyButtons = document.querySelectorAll('.difficulty-button');

        // 放課後アクションUI
        const afterSchoolActions = document.getElementById('after-school-actions');
        const actionStudy = document.getElementById('action-study');
        const actionTalkClassmate = document.getElementById('action-talk-classmate');
        const actionNextDay = document.getElementById('action-next-day');
        const actionsLeftDisplay = document.getElementById('actions-left-display');
        const remainingActionsSpan = document.getElementById('remaining-actions');

        // メッセージボックスの要素
        const messageBox = document.getElementById('message-box');
        const messageBoxOverlay = document.getElementById('message-box-overlay');
        const messageBoxTitle = document.getElementById('message-box-title');
        const messageBoxContent = document.getElementById('message-box-content');
        const messageBoxCloseButton = document.getElementById('message-box-close');

        // サウンドシンセサイザーの初期化 (Tone.js)
        const correctSynth = new Tone.Synth().toDestination();
        const incorrectSynth = new Tone.PolySynth().toDestination();
        let bgmLoop; // BGM用のループオブジェクト

        // BGMの初期化と再生
        function setupBGM() {
            // シンプルなアンビエントBGM (Tone.js Synth Loop)
            const synth = new Tone.Synth({
                oscillator: { type: 'sine' },
                envelope: {
                    attack: 2,
                    decay: 1,
                    sustain: 0.5,
                    release: 2
                }
            }).toDestination();

            // C3, E3, G3, C4 のコードをゆっくりと繰り返す
            bgmLoop = new Tone.Loop(time => {
                synth.triggerAttackRelease(['C3', 'E3', 'G3', 'C4'], '4n', time);
            }, '4n'); // 4分音符ごとにループ

            // BGMの音量を調整
            Tone.Destination.volume.value = -15; // デフォルトより小さくする

            // BGMの再生開始はユーザーの操作後に行う (ブラウザの制限のため)
            // ここでは初期化のみ行い、ゲームスタート時にTone.start()を呼ぶ
        }

        // 全単語リスト (300語) - ユーザー提供のクリーンなリストを使用
        const rawWords = `create 創造する
base 基礎
repair 修理する
fail 失敗する
accept 受け入れる
belong 属する
exchange 交換する
complete 完成させる
treat 扱う
cross 横切る
hide 隠す
shake 振る
challenge 挑戦する
connect つなぐ
reply 返事をする
beat 打ち負かす
share 分かち合う
observe 観察する
mark しるしをつける
burn 燃やす
locate 位置する
fix 修理する
suit 最適である
destroy 破壊する
control 制御する
respond 返答する
depend 頼る
forgive 許す
attack 襲う
sink 沈む
appreciate 感謝する
feed 与える
success 成功
mystery 謎
ceremony 式典
schedule 予定
damage 損害
model モデル
search 捜索
project 計画
form 形
scene 場面
accident 事故
contact 連絡
image イメージ
trust 信頼
quality 質
action 行動
lack 不足
spot 場所
truth 真実
effort 努力
type 型
site 敷地
tool 道具
couple 2人
hero 英雄
courage 勇気
board 板
purpose 目的
waste 無駄
shape 形
technique 技術
middle 中央
spirit 精神
partner パートナー
population 人口
fever 熱
method 方法
structure 構造
background 経歴
combination 組み合わせ
official 公式の
flat 平らな
serious 深刻な
ordinary 普通の
private 私的な
major 主要な
classical クラシックの
honest 正直な
excellent 優れた
whole 全体の
central 中心的な
ancient 古代の
fantastic すばらしい
regular 定期的な
basic 基本的な
huge 巨大な
empty 空の
smart 賢い
general 一般的な
single 1つの
responsible 責任のある
fresh 新鮮な
familiar 熟知している
native 出生地の
instant 即時の
lovely すてきな
clear 明白な
convenient 便利な
crazy 夢中で
funny おかしい
secret 秘密の
remote 遠くの
wake 目を覚ます
release 解放する
establish 設立する
examine 調べる
celebrate 祝う
float 漂う
recommend 推薦する
supply 供給する
disappear 消える
apologize 謝る
paint 塗る
pull 引く
print 印刷する
lift 持ち上げる
separate 分ける
melt 溶ける
strike 打つ
blow 吹く
let させる
roll 転がる
recover 回復する
surround 囲む
doubt 疑う
display 展示する
announce 発表する
support 支持する
act 行動する
repeat 繰り返す
count 数える
compare 比べる
shine 輝く
replace 取って代わる
reality 現実
strength 力
era 時代
area 地域
respect 尊敬
pressure 重圧
pleasure 喜び
favor 親切な行為
statue 像
limit 限度
bottom 下部
position 立場
memory 記憶
level 水準
figure 数
direction 方向
bit 少し
contrast 対比
religion 宗教
harmony 調和
pattern 模様
stage 段階
degree 程度
emergency 緊急事態
origin 起源
battle 戦闘
enemy 敵
note メモ
countryside 田舎
contest 競技
sort 種類
depth 深さ
top 頂上
theme テーマ
sentence 文
cycle 周期
concept 概念
rhythm リズム
tradition 伝統
theory 理論
correct 正しい
blank 空白の
quiet 静かな
smooth 滑らかな
wet 濡れた
chief 主要な
raw 生の
personal 個人の
double 2倍の
dirty 汚れた
normal 普通の
full いっぱいの
simple 簡単な
equal 等しい
quick 素早い
rapid 急速な
ideal 理想的な
rough 粗い
silent 静かな
violent 暴力的な
rich 豊富な
perfect 完璧な
weak 弱い
upper 上の
inner 内部の
awful ひどい
FALSE 間違った
vivid 鮮やかな
pure 純粋な
minor 重要でない
mild 穏やかな
admire 賞賛する
drop 落とす
reflect 映す
dig 掘る
beg 懇願する
freeze 凍る
adopt 採用する
measure 測る
flow 流れる
fulfill 実現させる
deliver 配達する
wrap 包む
knock ノックする
spell つづる
rush 急いで行く
pray 祈る
reject 拒絶する
protest 抗議する
handle 扱う
disturb 邪魔する
gather 集める
copy コピーする
press 押す
consist 成り立つ
assist 手助けする
kick 蹴る
link 結びつける
adjust 調整する
defend 守る
shut 閉める
bear 耐える
task 仕事
hug ハグ
clue 手がかり
percent パーセント
dozen 1ダース
ghost 幽霊
error 誤り
trend 傾向
thought 考え
alarm 警報
sample 見本
shadow 影
shade 日陰
standard 基準
hunger 飢え
appeal 訴え
harm 害
pile 山
plenty たくさん
edge 端
poison 毒
scale 規模
section 部門
attempt 試み
merit 長所
trick いたずら
second 少しの間
medium 媒体
unit 単位
ambition 願望
midnight 夜の12時
power 力
principle 信条
vision 展望
quarter 4分の1
luck 運
quantity 数量
fault 責任
somehow なんとかして
forever 永遠に
mostly 主に
forward 前へ
nowadays 近頃
ahead 前方に
apart 離れて
altogether まったく
throughout ～の間中
beyond ～の向こうに
toward ～の方向へ
within ～以内に
above ～の上に
below ～の下に
per ～につき
except ～を除いて
beside ～のそばに
unlike ～と違って
outside ～の外に
inside ～の中に
against ～に反対して
beneath ～の下に
plus ～を加えて
across ～を横切って
bring back 返す`;

        // rawWordsを解析して、englishとcorrectのペアの配列を作成
        const parsedWords = rawWords.split('\n').map(line => {
            // 各行は "EnglishWord 日本語訳" の形式なので、最初のスペースで分割
            const parts = line.trim().split(' ');
            let english = parts[0].trim();
            // 2番目以降の要素を結合して日本語訳とする
            let correct = parts.slice(1).join(' ').trim();

            return { english, correct };
        }).filter(q => q.english !== '' && q.correct !== ''); // 空の単語や意味を除外

        // 全ての正しい意味のリストを作成 (選択肢生成用)
        // Setを使ってユニークな意味のみを抽出し、空の文字列も除外
        const allMeanings = Array.from(new Set(parsedWords.map(q => q.correct).filter(m => m !== '')));

        // 選択肢を生成する関数
        function generateOptions(currentCorrectMeaning, allMeaningsPool) {
            const incorrectOptions = new Set();
            // 正しい意味を除外した選択肢プール (正しい意味と一致しないものだけを抽出)
            const availableMeaningsForIncorrect = allMeaningsPool.filter(m => m !== currentCorrectMeaning);

            // 3つの異なる不正解の選択肢を選ぶ
            // availableMeaningsForIncorrectのコピーを作成し、選択したものを削除していくことで重複を防ぐ
            let tempAvailable = [...availableMeaningsForIncorrect];
            while (incorrectOptions.size < 3 && tempAvailable.length > 0) {
                const randomIndex = Math.floor(Math.random() * tempAvailable.length);
                const selectedOption = tempAvailable[randomIndex];
                if (!incorrectOptions.has(selectedOption)) { // Setにより重複を避ける
                    incorrectOptions.add(selectedOption);
                }
                tempAvailable.splice(randomIndex, 1); // 選択したものをプールから削除
            }

            // もし3つの不正解の選択肢が揃わなかった場合、ダミーの選択肢で埋める
            // ダミーの選択肢が既存の正しい意味と重複しないように、よりユニークな文字列を使用
            let dummyCounter = 1;
            while (incorrectOptions.size < 3) {
                const dummyOption = `誤訳${dummyCounter++}`;
                // ダミーが既存の正しい意味や既に選ばれた不正解の選択肢と重複しないことを確認
                if (!allMeaningsPool.includes(dummyOption) && !incorrectOptions.has(dummyOption) && dummyOption !== currentCorrectMeaning) {
                     incorrectOptions.add(dummyOption);
                }
                // 無限ループを防ぐためのブレーク条件（万が一ダミーも生成できない場合）
                if (dummyCounter > 10) break;
            }

            // 正しい選択肢と不正解の選択肢を結合
            let finalOptions = Array.from(incorrectOptions);
            finalOptions.push(currentCorrectMeaning); // 正しい意味を必ず追加

            // 最終チェック: もし何らかの理由で正しい意味が重複して追加された場合、Setで再度ユニークにする
            finalOptions = Array.from(new Set(finalOptions));

            // 全ての選択肢をシャッフル
            return shuffleArray(finalOptions);
        }

        // 全ての単語に選択肢を付与
        const questionsWithOptions = parsedWords.map(q => ({
            english: q.english,
            correct: q.correct,
            options: generateOptions(q.correct, [...allMeanings]) // allMeaningsのコピーを渡す
        }));

        // 難易度別に単語を分配 (100語ずつ)
        const allQuestions = {
            easy: questionsWithOptions.slice(0, 100),
            normal: questionsWithOptions.slice(100, 200),
            hard: questionsWithOptions.slice(200, 300)
        };

        // 配列をシャッフルするユーティリティ関数（Fisher-Yatesアルゴリズム）
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // ゲームを初期状態にする（難易度選択画面）
        function showStartMenu() {
            gamePhase = 'start_menu';
            score = 0;
            currentDay = 1;
            playerStats.academicAbility = 1;
            playerStats.concentration = 1;
            playerStats.luck = 1;
            classmates.forEach(c => {
                c.affinity = 0; // 親密度をリセット
                c.events.forEach(e => e.triggered = false); // イベントトリガー状態をリセット
            });
            correctAnswersToday = 0; // 正解数をリセット
            availableAfterSchoolActions = 0; // アクション回数をリセット

            updatePlayerStatsDisplay();
            scoreDisplay.textContent = '0';
            totalQuestionsDisplay.textContent = totalQuestionsPerDay * totalGameDays; // 総問題数を更新

            shojiComment.textContent = 'SHOJI先生の英単語道場へようこそ！難易度を選んでゲームを始めよう！';
            blackboardWord.textContent = '難易度を選択してください';
            feedbackMessage.classList.add('hidden');
            startButton.classList.add('hidden'); // startButtonを隠す
            timerArea.classList.add('hidden'); // timerAreaを隠す
            answerButtonsContainer.innerHTML = '';
            afterSchoolActions.classList.add('hidden'); // afterSchoolActionsを隠す
            difficultySelection.classList.remove('hidden'); // 難易度選択を表示
        }

        // 難易度選択後のゲーム初期化
        function initializeGame(selectedDifficulty) {
            difficultyLevel = selectedDifficulty;
            gamePhase = 'quiz_phase';
            currentQuestionIndex = 0;
            score = 0;
            currentDay = 1;
            playerStats.academicAbility = 1;
            playerStats.concentration = 1;
            playerStats.luck = 1;
            classmates.forEach(c => {
                c.affinity = 0; // 親密度をリセット
                c.events.forEach(e => e.triggered = false); // イベントトリガー状態をリセット
            });
            correctAnswersToday = 0; // 正解数をリセット
            availableAfterSchoolActions = 0; // アクション回数をリセット


            updatePlayerStatsDisplay();
            scoreDisplay.textContent = score;
            // 選択された難易度の総問題数を表示
            totalQuestionsDisplay.textContent = allQuestions[difficultyLevel].length;

            // 難易度に応じた問題セットを準備
            questions = shuffleArray([...allQuestions[difficultyLevel]]);
            // 1日あたりの問題数に制限 (10問)
            questions = questions.slice(0, totalQuestionsPerDay);

            shojiComment.textContent = '準備はいいかい？さあ、今日の英単語だ！';
            feedbackMessage.classList.add('hidden');
            startButton.classList.add('hidden'); // startButtonを隠す
            difficultySelection.classList.add('hidden'); // 難易度選択を非表示
            timerArea.classList.remove('hidden'); // タイマーを表示

            // BGMの再生開始
            Tone.start();
            if (bgmLoop) {
                bgmLoop.start(0);
            } else {
                setupBGM();
                bgmLoop.start(0);
            }

            startQuizDay();
        }

        // プレイヤーのステータス表示を更新
        function updatePlayerStatsDisplay() {
            statAcademic.textContent = playerStats.academicAbility.toFixed(1); // 小数点以下1桁まで表示
            statConcentration.textContent = playerStats.concentration.toFixed(1);
            statLuck.textContent = playerStats.luck.toFixed(1);
            currentDayDisplay.textContent = `${currentDay}日目`;
        }

        // クイズフェーズを開始
        function startQuizDay() {
            gamePhase = 'quiz_phase';
            currentQuestionIndex = 0; // その日の問題のインデックスをリセット
            correctAnswersToday = 0; // その日の正解数をリセット

            // その日の問題セットを再シャッフルして取得
            questions = shuffleArray([...allQuestions[difficultyLevel]]);
            // 1日あたりの問題数に制限 (10問)
            questions = questions.slice(0, totalQuestionsPerDay);

            displayQuestion();
        }

        // 問題を表示する関数
        function displayQuestion() {
            // その日の問題が終了しているかチェック
            if (currentQuestionIndex >= questions.length) {
                endQuizDay(); // その日のクイズ終了
                return;
            }

            const currentQuestion = questions[currentQuestionIndex];
            // 黒板の単語にアニメーションクラスを追加
            blackboardWord.classList.remove('blackboard-word-animated'); // 前のアニメーションをリセット
            void blackboardWord.offsetWidth; // リフローを強制してアニメーションを再トリガー
            blackboardWord.textContent = currentQuestion.english; // 英単語を黒板に表示
            blackboardWord.classList.add('blackboard-word-animated'); // アニメーションを適用

            // 選択肢を生成
            const allOptions = generateOptions(currentQuestion.correct, [...allMeanings]); // 修正: 正しい選択肢を生成関数に含める
            answerButtonsContainer.innerHTML = ''; // 既存のボタンをクリア
            answerButtonsContainer.classList.remove('hidden'); // ボタンエリアを表示

            allOptions.forEach(option => {
                const button = document.createElement('button');
                button.textContent = option;
                button.classList.add(
                    'answer-button',
                    'px-6', 'py-4', 'bg-blue-500', 'text-white', 'text-xl', 'font-semibold',
                    'rounded-xl', 'shadow-md', 'hover:bg-blue-600', 'transition', 'duration-300',
                    'ease-in-out', 'transform', 'active:scale-98', 'focus:outline-none', 'focus:ring-2',
                    'focus:ring-blue-400', 'focus:ring-opacity-75'
                );
                button.dataset.answer = option; // データ属性に選択肢を保存
                button.addEventListener('click', handleAnswerClick); // クリックイベントリスナーを追加
                answerButtonsContainer.appendChild(button);
            });

            enableAnswerButtons();
            feedbackMessage.classList.add('hidden');
            shojiComment.textContent = `第${currentQuestionIndex + 1}問！この単語の意味は？`;

            // 集中力に応じて制限時間を調整
            questionTimeLimit = 10 + (Math.floor(playerStats.concentration) - 1) * 2; // 集中力は小数点以下を切り捨てて計算
            startTimer();
        }

        // タイマーを開始する関数
        function startTimer() {
            clearInterval(timerInterval); // 前のタイマーをクリア
            timeLeft = questionTimeLimit;
            timerText.textContent = `残り時間: ${timeLeft}秒`;
            timerBar.style.width = '100%';
            timerBar.style.backgroundColor = '#22c55e'; // green-500

            timerInterval = setInterval(() => {
                timeLeft--;
                timerText.textContent = `残り時間: ${timeLeft}秒`;
                const percentage = (timeLeft / questionTimeLimit) * 100;
                timerBar.style.width = `${percentage}%`;

                if (percentage <= 25) {
                    timerBar.style.backgroundColor = '#ef4444'; // red-500
                } else if (percentage <= 50) {
                    timerBar.style.backgroundColor = '#facc15'; // yellow-500
                }

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    handleAnswer(null); // 時間切れとして処理
                }
            }, 1000);
        }

        // 回答ボタンがクリックされた時の処理
        function handleAnswerClick(event) {
            clearInterval(timerInterval); // タイマーを停止
            const selectedAnswer = event.target.dataset.answer;
            handleAnswer(selectedAnswer);
        }

        // 回答を処理する共通関数
        function handleAnswer(selectedAnswer) {
            disableAnswerButtons();
            const currentQuestion = questions[currentQuestionIndex];

            if (selectedAnswer === currentQuestion.correct) {
                score++;
                correctAnswersToday++; // その日の正解数を加算
                scoreDisplay.textContent = score;
                feedbackMessage.textContent = '正解！素晴らしい！';
                feedbackMessage.classList.remove('text-red-600', 'hidden');
                feedbackMessage.classList.add('text-green-600', 'block');
                shojiComment.textContent = 'Excellent! その調子だ！';
                playCorrectSound();
                playerStats.academicAbility += 0.1; // 学力アップ
                // 運に応じてボーナススコア
                if (Math.random() * 10 < playerStats.luck) { // 運が高いほど発動しやすい
                    score++;
                    scoreDisplay.textContent = score;
                    feedbackMessage.textContent += ' (運ボーナス！)';
                }
            } else {
                feedbackMessage.textContent = `不正解... 正解は「${currentQuestion.correct}」だよ。`;
                feedbackMessage.classList.remove('text-green-600', 'hidden');
                feedbackMessage.classList.add('text-red-600', 'block');
                shojiComment.textContent = 'Don\'t worry, next time! 諦めるな！';
                playIncorrectSound();
            }
            updatePlayerStatsDisplay(); // ステータス表示を更新

            // 特定のスコアや状況でSHOJI先生の特別なコメント
            if (score >= 3 && score < 5 && currentQuestionIndex < questions.length - 1) {
                shojiComment.textContent = '君の成長は目覚ましいな！この調子で頑張りたまえ！';
            } else if (score >= 5 && currentQuestionIndex < questions.length - 1) {
                shojiComment.textContent = '素晴らしい集中力だ！君はきっと大物になるぞ！';
            }

            currentQuestionIndex++;
            // その日のクイズがまだ残っている場合は次の問題へ進むボタンを表示
            if (currentQuestionIndex < questions.length) {
                startButton.textContent = '次の問題へ';
                startButton.classList.remove('hidden'); // ここでボタンを表示
            } else {
                // その日のクイズが終了したら放課後フェーズへ
                startButton.classList.add('hidden'); // 次の問題へボタンを隠す
                setTimeout(endQuizDay, 1500); // 少し間を置いて放課後へ
            }
        }

        // 回答ボタンを有効にする関数
        function enableAnswerButtons() {
            const buttons = answerButtonsContainer.querySelectorAll('.answer-button');
            buttons.forEach(button => {
                button.disabled = false;
                button.classList.remove('opacity-50', 'cursor-not-allowed');
            });
        }

        // 回答ボタンを無効にする関数
        function disableAnswerButtons() {
            const buttons = answerButtonsContainer.querySelectorAll('.answer-button');
            buttons.forEach(button => {
                button.disabled = true;
                button.classList.add('opacity-50', 'cursor-not-allowed');
            });
        }

        // 正解音を再生する関数 (Tone.js)
        function playCorrectSound() {
            correctSynth.triggerAttackRelease('C5', '8n'); // ドの音を短く鳴らす
        }

        // 不正解音を再生する関数 (Tone.js)
        function playIncorrectSound() {
            incorrectSynth.triggerAttackRelease(['C3', 'F#3'], '8n'); // 不協和音を短く鳴らす
        }

        // その日のクイズ終了時の処理
        function endQuizDay() {
            clearInterval(timerInterval);
            gamePhase = 'after_school_phase';
            shojiComment.textContent = `今日の授業は終わりだ！${correctAnswersToday}問正解したぞ！放課後をどう過ごす？`;
            blackboardWord.textContent = '放課後';
            blackboardWord.classList.remove('blackboard-word-animated');
            answerButtonsContainer.innerHTML = ''; // クイズボタンをクリア
            answerButtonsContainer.classList.add('hidden'); // ボタンエリアを非表示
            startButton.classList.add('hidden'); // startButtonを隠す
            feedbackMessage.classList.add('hidden');
            timerArea.classList.add('hidden'); // タイマーを非表示

            availableAfterSchoolActions = correctAnswersToday; // 正解数分のアクション回数を付与
            showAfterSchoolActions(); // 放課後アクションを表示
        }

        // 放課後アクションを表示する関数
        function showAfterSchoolActions() {
            afterSchoolActions.classList.remove('hidden'); // afterSchoolActionsを表示
            remainingActionsSpan.textContent = availableAfterSchoolActions; // 残りアクション回数を更新

            // アクションボタンの有効/無効を切り替える
            if (availableAfterSchoolActions > 0) {
                actionStudy.disabled = false;
                actionTalkClassmate.disabled = false;
                actionStudy.classList.remove('opacity-50', 'cursor-not-allowed');
                actionTalkClassmate.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                actionStudy.disabled = true;
                actionTalkClassmate.disabled = true;
                actionStudy.classList.add('opacity-50', 'cursor-not-allowed');
                actionTalkClassmate.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }

        // 放課後アクションの処理
        function handleAfterSchoolAction(actionType) {
            // アクション回数がある場合のみ実行
            if ((actionType === 'study' || actionType === 'talk_classmate') && availableAfterSchoolActions <= 0) {
                showMessageBox('アクション不可', 'これ以上アクションはできません。次の日へ進みましょう。');
                return;
            }

            feedbackMessage.classList.add('hidden');

            switch (actionType) {
                case 'study':
                    playerStats.academicAbility += (Math.floor(Math.random() * 2) + 1) * (1 + playerStats.luck * 0.1); // 運に応じてボーナス
                    playerStats.concentration += (Math.floor(Math.random() * 0.5) + 0.5);
                    shojiComment.textContent = 'よし、勉強したな！学力が上がったぞ！';
                    showMessageBox('勉強', '参考書を広げ、黙々と勉強した。学力が少し上がった！');
                    availableAfterSchoolActions--;
                    break;
                case 'talk_classmate':
                    // ランダムなクラスメイトと交流
                    const randomClassmate = classmates[Math.floor(Math.random() * classmates.length)];
                    randomClassmate.affinity += (Math.floor(Math.random() * 3) + 1) * (1 + playerStats.academicAbility * 0.1); // 学力に応じてボーナス
                    playerStats.luck += 0.1; // 運も少し上がるかも
                    shojiComment.textContent = `${randomClassmate.name}と話したぞ！親密度が上がった！`;
                    showMessageBox('交流', `${randomClassmate.name}と楽しく話した。親密度が上がった！`);

                    // 親密度イベントのチェック
                    checkClassmateEvents(randomClassmate);
                    availableAfterSchoolActions--;
                    break;
                case 'next_day':
                    currentDay++;
                    if (currentDay > totalGameDays) {
                        endGame(); // 全日程終了
                    } else {
                        // 特定の日数でイベント発生
                        if (currentDay === Math.floor(totalGameDays / 2) + 1) { // 例: 中間地点でイベント
                            shojiComment.textContent = '来週は学園祭だ！英語劇の準備は順調か？';
                            showMessageBox('学園祭の準備', '学園祭が近づいてきた！クラスの出し物の準備で忙しい。');
                        }
                        startQuizDay(); // 次の日のクイズ開始
                    }
                    break;
            }
            updatePlayerStatsDisplay();
            remainingActionsSpan.textContent = availableAfterSchoolActions; // 残りアクション回数を更新
            showAfterSchoolActions(); // ボタンの状態を更新
        }

        // クラスメイトの親密度イベントをチェック
        function checkClassmateEvents(classmate) {
            classmate.events.forEach(event => {
                if (classmate.affinity >= event.threshold && !event.triggered) {
                    event.triggered = true; // イベントは一度だけ発生
                    showMessageBox(`${classmate.name}とのイベント`, event.message);
                    // ここでイベントタイプに応じた処理を追加 (例: クエスト開始、ミニゲームなど)
                }
            });
        }

        // ゲーム全体の終了処理
        function endGame() {
            clearInterval(timerInterval);
            if (bgmLoop) {
                bgmLoop.stop(); // BGMを停止
            }
            gamePhase = 'game_over';
            shojiComment.textContent = 'これで全日程終了だ！よく頑張ったな！';
            blackboardWord.textContent = 'ゲーム終了！';
            blackboardWord.classList.remove('blackboard-word-animated');
            answerButtonsContainer.innerHTML = '';
            answerButtonsContainer.classList.add('hidden'); // answerButtonsContainerを隠す
            startButton.textContent = 'もう一度プレイする';
            startButton.classList.remove('hidden'); // startButtonを表示
            feedbackMessage.classList.add('hidden');
            timerArea.classList.add('hidden'); // timerAreaを隠す
            afterSchoolActions.classList.add('hidden'); // afterSchoolActionsを隠す

            let finalMessage = `君の最終スコアは ${score} だ！\n`;
            finalMessage += `学力: ${playerStats.academicAbility.toFixed(1)}, 集中力: ${playerStats.concentration.toFixed(1)}, 運: ${playerStats.luck.toFixed(1)}\n`;
            classmates.forEach(c => {
                finalMessage += `${c.name}との親密度: ${c.affinity}\n`;
            });
            finalMessage += '\nお疲れ様！素晴らしい学園生活だったね！';

            showMessageBox(
                'ゲーム終了！',
                finalMessage
            );
        }

        // カスタムメッセージボックスを表示する関数
        function showMessageBox(title, content) {
            messageBoxTitle.textContent = title;
            messageBoxContent.textContent = content;
            messageBoxOverlay.style.display = 'block';
            messageBox.style.display = 'block';
        }

        // カスタムメッセージボックスを閉じる関数
        function closeMessageBox() {
            messageBoxOverlay.style.display = 'none';
            messageBox.style.display = 'none';
            // メッセージボックスを閉じたら、次のフェーズへ進む
            if (gamePhase === 'quiz_phase' && currentQuestionIndex < questions.length) {
                startButton.classList.remove('hidden'); // 次の問題へボタンを表示
            } else if (gamePhase === 'after_school_phase') {
                showAfterSchoolActions(); // 放課後アクションを再表示
            } else if (gamePhase === 'game_over') {
                showStartMenu(); // ゲームオーバー後はスタートメニューへ
            }
        }

        // イベントリスナーの設定
        // 難易度選択ボタン
        difficultyButtons.forEach(button => {
            button.addEventListener('click', (event) => {
                const selectedDifficulty = event.target.dataset.difficulty;
                initializeGame(selectedDifficulty);
            });
        });

        // 次の問題へ/ゲームスタート/再プレイボタン
        startButton.addEventListener('click', () => {
            if (gamePhase === 'quiz_phase' && currentQuestionIndex < questions.length) {
                displayQuestion(); // 次の問題を表示
                startButton.classList.add('hidden'); // 次の問題へボタンを非表示に
            } else if (gamePhase === 'game_over') {
                showStartMenu(); // ゲームオーバー後の再プレイ
            }
        });

        // 放課後アクションボタン
        actionStudy.addEventListener('click', () => handleAfterSchoolAction('study'));
        actionTalkClassmate.addEventListener('click', () => handleAfterSchoolAction('talk_classmate'));
        actionNextDay.addEventListener('click', () => handleAfterSchoolAction('next_day'));

        messageBoxCloseButton.addEventListener('click', closeMessageBox);

        // ウィンドウが完全に読み込まれた後にゲームを初期状態にする
        window.onload = function() {
            setupBGM(); // BGMシンセサイザーの初期化
            showStartMenu(); // 最初にスタートメニューを表示
        };

    </script>
</body>
</html>
